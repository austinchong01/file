<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom styles for SVG icons */
        .custom-folder-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 12px;
            transition: transform 0.2s ease;
        }
        
        .custom-folder-icon:hover {
            transform: scale(1.1);
        }
        
        /* Style the SVG paths to match the warning color theme */
        .custom-folder-icon path {
            stroke: #ffc107; /* Bootstrap warning color */
            stroke-width: 2;
            fill: none;
        }
        
        .custom-folder-icon:hover path {
            stroke: #e0a800; /* Darker warning color on hover */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a href="/dashboard" class="navbar-brand"><i class="fas fa-cloud"></i> File Uploader</a>
            <div>
                <span class="text-light me-3">Hello, <%= user.name %>!</span>
                <a href="/auth/logout" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                <% if (folder.parent) { %>
                    <li class="breadcrumb-item"><a href="/folders/<%= folder.parent.id %>"><%= folder.parent.name %></a></li>
                <% } %>
                <li class="breadcrumb-item active"><%= folder.name %></li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <!-- Custom SVG Folder Icon for Header -->
                    <svg style="width: 48px; height: 48px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 8.2C3 7.07989 3 6.51984 3.21799 6.09202C3.40973 5.71569 3.71569 5.40973 4.09202 5.21799C4.51984 5 5.0799 5 6.2 5H9.67452C10.1637 5 10.4083 5 10.6385 5.05526C10.8425 5.10425 11.0376 5.18506 11.2166 5.29472C11.4184 5.4184 11.5914 5.59135 11.9373 5.93726L12.0627 6.06274C12.4086 6.40865 12.5816 6.5816 12.7834 6.70528C12.9624 6.81494 13.1575 6.89575 13.3615 6.94474C13.5917 7 13.8363 7 14.3255 7H17.8C18.9201 7 19.4802 7 19.908 7.21799C20.2843 7.40973 20.5903 7.71569 20.782 8.09202C21 8.51984 21 9.0799 21 10.2V15.8C21 16.9201 21 17.4802 20.782 17.908C20.5903 18.2843 20.2843 18.5903 19.908 18.782C19.4802 19 18.9201 19 17.8 19H6.2C5.07989 19 4.51984 19 4.09202 18.782C3.71569 18.5903 3.40973 18.2843 3.21799 17.908C3 17.4802 3 16.9201 3 15.8V8.2Z" stroke="#ffc107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <%= folder.name %>
                </h1>
                <% if (folder.description) { %>
                    <p class="text-muted"><%= folder.description %></p>
                <% } %>
            </div>
            <div>
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#folderModal">
                    <i class="fas fa-folder-plus"></i> New Folder
                </button>
                <a href="/files/upload?folderId=<%= folder.id %>" class="btn btn-success">
                    <i class="fas fa-upload"></i> Upload
                </a>
            </div>
        </div>

        <!-- Contents -->
        <div class="row">
            <!-- Subfolders with Custom SVG Icons -->
            <% folders.forEach(subfolder => { %>
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center d-flex flex-column">
                        <a href="/folders/<%= subfolder.id %>" class="text-decoration-none">
                            <!-- Custom SVG Folder Icon -->
                            <svg class="custom-folder-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 8.2C3 7.07989 3 6.51984 3.21799 6.09202C3.40973 5.71569 3.71569 5.40973 4.09202 5.21799C4.51984 5 5.0799 5 6.2 5H9.67452C10.1637 5 10.4083 5 10.6385 5.05526C10.8425 5.10425 11.0376 5.18506 11.2166 5.29472C11.4184 5.4184 11.5914 5.59135 11.9373 5.93726L12.0627 6.06274C12.4086 6.40865 12.5816 6.5816 12.7834 6.70528C12.9624 6.81494 13.1575 6.89575 13.3615 6.94474C13.5917 7 13.8363 7 14.3255 7H17.8C18.9201 7 19.4802 7 19.908 7.21799C20.2843 7.40973 20.5903 7.71569 20.782 8.09202C21 8.51984 21 9.0799 21 10.2V15.8C21 16.9201 21 17.4802 20.782 17.908C20.5903 18.2843 20.2843 18.5903 19.908 18.782C19.4802 19 18.9201 19 17.8 19H6.2C5.07989 19 4.51984 19 4.09202 18.782C3.71569 18.5903 3.40973 18.2843 3.21799 17.908C3 17.4802 3 16.9201 3 15.8V8.2Z" stroke="#ffc107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </a>
                        <h6 class="card-title"><%= subfolder.name %></h6>
                        <% if (subfolder.description) { %>
                            <small class="text-muted flex-grow-1"><%= subfolder.description %></small>
                        <% } %>
                        <div class="mt-auto">
                            <form method="POST" action="/folders/<%= subfolder.id %>?_method=DELETE" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger" 
                                        onclick="return confirm('Delete folder and all its contents?')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <% }); %>

            <!-- Files -->
            <% files.forEach(file => { %>
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center d-flex flex-column">
                        <% 
                        let iconClass = 'fa-file';
                        if (file.mimetype.startsWith('image/')) iconClass = 'fa-file-image text-info';
                        else if (file.mimetype.startsWith('video/')) iconClass = 'fa-file-video text-danger';
                        else if (file.mimetype.startsWith('audio/')) iconClass = 'fa-file-audio text-success';
                        else if (file.mimetype === 'application/pdf') iconClass = 'fa-file-pdf text-danger';
                        else iconClass = 'fa-file text-secondary';
                        
                        // Use displayName if available, otherwise fall back to originalName
                        let displayFileName = file.displayName || file.originalName;
                        %>
                        <i class="fas <%= iconClass %> fa-3x mb-2" 
                           style="cursor: pointer;" 
                           onclick="console.log('clicked')"></i>
                        <h6 class="card-title" title="<%= displayFileName %>">
                            <%= displayFileName.length > 20 ? displayFileName.substring(0, 20) + '...' : displayFileName %>
                        </h6>
                        <small class="text-muted flex-grow-1">
                            <%= (file.size / 1024).toFixed(1) %> KB<br>
                            <small><%= new Date(file.createdAt).toLocaleDateString() %></small>
                        </small>
                        <div class="mt-auto">
                            <div class="btn-group w-100" role="group">
                                <a href="/files/<%= file.id %>/download" class="btn btn-sm btn-success" title="Download">
                                    <i class="fas fa-download"></i>
                                </a>
                                <form method="POST" action="/files/<%= file.id %>?_method=DELETE" class="flex-fill">
                                    <button type="submit" class="btn btn-sm btn-danger w-100" 
                                            onclick="return confirm('Delete this file?')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% }); %>
        </div>

        <% if (folders.length === 0 && files.length === 0) { %>
        <div class="text-center mt-5">
            <!-- Custom SVG for empty state -->
            <svg class="custom-folder-icon" style="width: 80px; height: 80px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 8.2C3 7.07989 3 6.51984 3.21799 6.09202C3.40973 5.71569 3.71569 5.40973 4.09202 5.21799C4.51984 5 5.0799 5 6.2 5H9.67452C10.1637 5 10.4083 5 10.6385 5.05526C10.8425 5.10425 11.0376 5.18506 11.2166 5.29472C11.4184 5.4184 11.5914 5.59135 11.9373 5.93726L12.0627 6.06274C12.4086 6.40865 12.5816 6.5816 12.7834 6.70528C12.9624 6.81494 13.1575 6.89575 13.3615 6.94474C13.5917 7 13.8363 7 14.3255 7H17.8C18.9201 7 19.4802 7 19.908 7.21799C20.2843 7.40973 20.5903 7.71569 20.782 8.09202C21 8.51984 21 9.0799 21 10.2V15.8C21 16.9201 21 17.4802 20.782 17.908C20.5903 18.2843 20.2843 18.5903 19.908 18.782C19.4802 19 18.9201 19 17.8 19H6.2C5.07989 19 4.51984 19 4.09202 18.782C3.71569 18.5903 3.40973 18.2843 3.21799 17.908C3 17.4802 3 16.9201 3 15.8V8.2Z" stroke="#6c757d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>Folder is empty</h3>
            <p class="text-muted">Create a subfolder or upload files to get started</p>
            <div>
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#folderModal">
                    <i class="fas fa-folder-plus"></i> Create Folder
                </button>
                <a href="/files/upload?folderId=<%= folder.id %>" class="btn btn-success">
                    <i class="fas fa-upload"></i> Upload File
                </a>
            </div>
        </div>
        <% } %>
    </div>

    <!-- Create Folder Modal -->
    <div class="modal fade" id="folderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Subfolder in <%= folder.name %></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/folders/create" method="POST">
                    <input type="hidden" name="parentId" value="<%= folder.id %>">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Folder Name</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   placeholder="Enter folder name" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" placeholder="Enter folder description"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-folder-plus"></i> Create Folder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div class="modal fade" id="filePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewFileName">File Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <a href="#" id="downloadLink" class="btn btn-success">
                        <i class="fas fa-download"></i> Download
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // File preview function
        function previewFile(fileId, fileName, mimetype, cloudinaryUrl, fileSize) {
            const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
            const previewContent = document.getElementById('previewContent');
            const previewFileName = document.getElementById('previewFileName');
            const downloadLink = document.getElementById('downloadLink');
            
            // Set modal title and download link
            previewFileName.textContent = fileName;
            downloadLink.href = `/files/${fileId}/download`;
            
            // Generate preview content based on file type
            let content = '';
            
            if (mimetype.startsWith('image/')) {
                content = `
                    <div class="text-center">
                        <img src="${cloudinaryUrl}" alt="${fileName}" class="img-fluid rounded shadow" style="max-height: 400px;">
                        <div class="mt-2">
                            <small class="text-muted">Size: ${fileSize} KB</small>
                        </div>
                    </div>
                `;
            } else if (mimetype === 'application/pdf') {
                content = `
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-file-pdf fa-5x text-danger"></i>
                        </div>
                        <h5>${fileName}</h5>
                        <p class="text-muted">PDF Document • ${fileSize} KB</p>
                        <a href="${cloudinaryUrl}" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt"></i> Open in New Tab
                        </a>
                    </div>
                `;
            } else if (mimetype.startsWith('video/')) {
                content = `
                    <div class="text-center">
                        <video controls class="w-100" style="max-height: 400px;">
                            <source src="${cloudinaryUrl}" type="${mimetype}">
                            Your browser does not support the video tag.
                        </video>
                        <div class="mt-2">
                            <small class="text-muted">Size: ${fileSize} KB</small>
                        </div>
                    </div>
                `;
            } else if (mimetype.startsWith('audio/')) {
                content = `
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-file-audio fa-5x text-success"></i>
                        </div>
                        <h5>${fileName}</h5>
                        <audio controls class="w-100 mt-3">
                            <source src="${cloudinaryUrl}" type="${mimetype}">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="mt-2">
                            <small class="text-muted">Size: ${fileSize} KB</small>
                        </div>
                    </div>
                `;
            } else if (mimetype.startsWith('text/') || mimetype.includes('document')) {
                let iconClass = 'fa-file';
                let iconColor = 'text-secondary';
                if (mimetype.includes('word')) { iconClass = 'fa-file-word'; iconColor = 'text-primary'; }
                else if (mimetype.includes('excel')) { iconClass = 'fa-file-excel'; iconColor = 'text-success'; }
                else if (mimetype.includes('powerpoint')) { iconClass = 'fa-file-powerpoint'; iconColor = 'text-warning'; }
                
                content = `
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas ${iconClass} fa-5x ${iconColor}"></i>
                        </div>
                        <h5>${fileName}</h5>
                        <p class="text-muted">Document • ${fileSize} KB</p>
                        <p class="text-muted">Preview not available for this document type</p>
                        <a href="${cloudinaryUrl}" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt"></i> Open in New Tab
                        </a>
                    </div>
                `;
            } else {
                content = `
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-file fa-5x text-secondary"></i>
                        </div>
                        <h5>${fileName}</h5>
                        <p class="text-muted">${mimetype} • ${fileSize} KB</p>
                        <p class="text-muted">Preview not available for this file type</p>
                    </div>
                `;
            }
            
            previewContent.innerHTML = content;
            modal.show();
        }
    </script>
</body>
</html>