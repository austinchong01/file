<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom styles for SVG icons */
        .custom-folder-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 12px;
            transition: transform 0.2s ease;
        }
        
        .custom-folder-icon:hover {
            transform: scale(1.1);
        }
        
        /* Style the SVG paths to match the warning color theme */
        .custom-folder-icon path {
            stroke: #ffc107; /* Bootstrap warning color */
            stroke-width: 2;
            fill: none;
        }
        
        .custom-folder-icon:hover path {
            stroke: #e0a800; /* Darker warning color on hover */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand"><i class="fas fa-cloud"></i> File Uploader</span>
            <div>
                <span class="text-light me-3">Hello, <%= user.name %>!</span>
                <a href="/auth/logout" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
            <div>
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#folderModal">
                    <i class="fas fa-folder-plus"></i> New Folder
                </button>
                <a href="/files/upload" class="btn btn-success">
                    <i class="fas fa-upload"></i> Upload
                </a>
            </div>
        </div>

        <!-- File Manager -->
        <div class="row">
            <!-- Folders with Custom SVG Icons -->
            <% folders.forEach(folder => { %>
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center d-flex flex-column">
                        <a href="/folders/<%= folder.id %>" class="text-decoration-none">
                            <!-- Custom SVG Folder Icon -->
                            <svg class="custom-folder-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 8.2C3 7.07989 3 6.51984 3.21799 6.09202C3.40973 5.71569 3.71569 5.40973 4.09202 5.21799C4.51984 5 5.0799 5 6.2 5H9.67452C10.1637 5 10.4083 5 10.6385 5.05526C10.8425 5.10425 11.0376 5.18506 11.2166 5.29472C11.4184 5.4184 11.5914 5.59135 11.9373 5.93726L12.0627 6.06274C12.4086 6.40865 12.5816 6.5816 12.7834 6.70528C12.9624 6.81494 13.1575 6.89575 13.3615 6.94474C13.5917 7 13.8363 7 14.3255 7H17.8C18.9201 7 19.4802 7 19.908 7.21799C20.2843 7.40973 20.5903 7.71569 20.782 8.09202C21 8.51984 21 9.0799 21 10.2V15.8C21 16.9201 21 17.4802 20.782 17.908C20.5903 18.2843 20.2843 18.5903 19.908 18.782C19.4802 19 18.9201 19 17.8 19H6.2C5.07989 19 4.51984 19 4.09202 18.782C3.71569 18.5903 3.40973 18.2843 3.21799 17.908C3 17.4802 3 16.9201 3 15.8V8.2Z" stroke="#ffc107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </a>
                        <h6 class="card-title"><%= folder.name %></h6>
                        <% if (folder.description) { %>
                            <small class="text-muted flex-grow-1"><%= folder.description %></small>
                        <% } %>
                        <div class="mt-auto">
                            <form method="POST" action="/folders/<%= folder.id %>?_method=DELETE" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger" 
                                        onclick="return confirm('Delete folder and all its contents?')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <% }); %>

            <!-- Files -->
            <% files.forEach(file => { %>
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center d-flex flex-column">
                        <% 
                        let iconClass = 'fa-file';
                        let iconColor = 'text-secondary';
                        if (file.mimetype.startsWith('image/')) { iconClass = 'fa-file-image'; iconColor = 'text-info'; }
                        else if (file.mimetype.startsWith('video/')) { iconClass = 'fa-file-video'; iconColor = 'text-danger'; }
                        else if (file.mimetype.startsWith('audio/')) { iconClass = 'fa-file-audio'; iconColor = 'text-success'; }
                        else if (file.mimetype === 'application/pdf') { iconClass = 'fa-file-pdf'; iconColor = 'text-danger'; }
                        else if (file.mimetype.includes('word')) { iconClass = 'fa-file-word'; iconColor = 'text-primary'; }
                        else if (file.mimetype.includes('excel')) { iconClass = 'fa-file-excel'; iconColor = 'text-success'; }
                        else if (file.mimetype.includes('powerpoint')) { iconClass = 'fa-file-powerpoint'; iconColor = 'text-warning'; }
                        
                        // Use displayName if available, otherwise fall back to originalName
                        let displayFileName = file.displayName || file.originalName;
                        %>
                        <i class="fas <%= iconClass %> fa-3x <%= iconColor %> mb-2"></i>
                        
                        <h6 class="card-title" title="<%= displayFileName %>">
                            <%= displayFileName.length > 20 ? displayFileName.substring(0, 20) + '...' : displayFileName %>
                        </h6>
                        
                        <small class="text-muted flex-grow-1">
                            <%= (file.size / 1024).toFixed(1) %> KB<br>
                            <small><%= new Date(file.createdAt).toLocaleDateString() %></small>
                        </small>
                        
                        <div class="mt-auto">
                            <!-- Action buttons -->
                            <div class="btn-group w-100" role="group">
                                <a href="/files/<%= file.id %>/download" class="btn btn-sm btn-success" title="Download">
                                    <i class="fas fa-download"></i>
                                </a>
                                <form method="POST" action="/files/<%= file.id %>?_method=DELETE" class="flex-fill">
                                    <button type="submit" class="btn btn-sm btn-danger w-100" 
                                            onclick="return confirm('Delete this file?')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% }); %>
        </div>

        <% if (folders.length === 0 && files.length === 0) { %>
        <div class="text-center mt-5">
            <!-- Custom SVG for empty state -->
            <svg class="custom-folder-icon" style="width: 80px; height: 80px; opacity: 0.5;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 8.2C3 7.07989 3 6.51984 3.21799 6.09202C3.40973 5.71569 3.71569 5.40973 4.09202 5.21799C4.51984 5 5.0799 5 6.2 5H9.67452C10.1637 5 10.4083 5 10.6385 5.05526C10.8425 5.10425 11.0376 5.18506 11.2166 5.29472C11.4184 5.4184 11.5914 5.59135 11.9373 5.93726L12.0627 6.06274C12.4086 6.40865 12.5816 6.5816 12.7834 6.70528C12.9624 6.81494 13.1575 6.89575 13.3615 6.94474C13.5917 7 13.8363 7 14.3255 7H17.8C18.9201 7 19.4802 7 19.908 7.21799C20.2843 7.40973 20.5903 7.71569 20.782 8.09202C21 8.51984 21 9.0799 21 10.2V15.8C21 16.9201 21 17.4802 20.782 17.908C20.5903 18.2843 20.2843 18.5903 19.908 18.782C19.4802 19 18.9201 19 17.8 19H6.2C5.07989 19 4.51984 19 4.09202 18.782C3.71569 18.5903 3.40973 18.2843 3.21799 17.908C3 17.4802 3 16.9201 3 15.8V8.2Z" stroke="#6c757d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>No files or folders</h3>
            <p class="text-muted">Start by creating a folder or uploading a file to cloud storage</p>
            <div>
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#folderModal">
                    <i class="fas fa-folder-plus"></i> Create Folder
                </button>
                <a href="/files/upload" class="btn btn-success">
                    <i class="fas fa-upload"></i> Upload File
                </a>
            </div>
        </div>
        <% } %>

        <!-- Statistics Card -->
        <% if (files.length > 0 || folders.length > 0) { %>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h6><i class="fas fa-chart-bar"></i> Storage Summary</h6>
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h4 class="text-primary"><%= files.length %></h4>
                                    <small class="text-muted">Files</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h4 class="text-warning"><%= folders.length %></h4>
                                    <small class="text-muted">Folders</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end">
                                    <h4 class="text-success">
                                        <%
                                        let totalSize = files.reduce((sum, file) => sum + file.size, 0);
                                        let units = ['B', 'KB', 'MB', 'GB'];
                                        let i = 0;
                                        while (totalSize >= 1024 && i < units.length - 1) {
                                            totalSize /= 1024;
                                            i++;
                                        }
                                        %>
                                        <%= totalSize.toFixed(i > 0 ? 1 : 0) %> <%= units[i] %>
                                    </h4>
                                    <small class="text-muted">Total Size</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-info">
                                    <i class="fas fa-cloud"></i>
                                </h4>
                                <small class="text-muted">Cloud Storage</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% } %>
    </div>

    <!-- Create Folder Modal -->
    <div class="modal fade" id="folderModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Folder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/folders/create" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Folder Name</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   placeholder="Enter folder name" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" placeholder="Enter folder description"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-folder-plus"></i> Create Folder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Add download progress indication
        document.addEventListener('DOMContentLoaded', function() {
            const downloadLinks = document.querySelectorAll('a[href*="/download"]');
            
            downloadLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const btn = this;
                    const originalHtml = btn.innerHTML;
                    
                    // Show downloading state
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btn.classList.add('disabled');
                    
                    // Reset after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('disabled');
                    }, 3000);
                });
            });
        });

        function showToast(message, type = 'info') {
            // Create toast element
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            // Add to page
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.innerHTML = toastHtml;
            const toastElement = toastContainer.querySelector('.toast');
            const toast = new bootstrap.Toast(toastElement, { delay: 2000 });
            toast.show();
        }
    </script>
</body>
</html>