<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <a href="/dashboard" class="navbar-brand"
          ><i class="fas fa-cloud"></i> File Uploader</a
        >
        <div>
          <span class="text-light me-3">Hello, <%= user.name %>!</span>
          <a href="/auth/logout" class="btn btn-outline-light btn-sm">Logout</a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Flash Messages -->
      <% if (success_msg && success_msg.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show">
          <%= success_msg %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>
      
      <% if (error_msg && error_msg.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show">
          <%= error_msg %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
          <% if (file.folder) { %>
          <li class="breadcrumb-item">
            <a href="/folders/<%= file.folder.id %>"><%= file.folder.name %></a>
          </li>
          <% } %>
          <li class="breadcrumb-item active"><%= file.originalName %></li>
        </ol>
      </nav>

      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-file"></i> File Details</h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3 text-center">
                  <!-- File Icon -->
                  <% let iconClass = 'fa-file'; let iconColor = 'text-secondary';
                  if (file.mimetype.startsWith('image/')) { iconClass = 'fa-file-image'; iconColor = 'text-info'; }
                  else if (file.mimetype.startsWith('video/')) { iconClass = 'fa-file-video'; iconColor = 'text-danger'; }
                  else if (file.mimetype.startsWith('audio/')) { iconClass = 'fa-file-audio'; iconColor = 'text-success'; }
                  else if (file.mimetype === 'application/pdf') { iconClass = 'fa-file-pdf'; iconColor = 'text-danger'; }
                  else if (file.mimetype.includes('word')) { iconClass = 'fa-file-word'; iconColor = 'text-primary'; }
                  else if (file.mimetype.includes('excel') || file.mimetype.includes('spreadsheet')) { iconClass = 'fa-file-excel'; iconColor = 'text-success'; }
                  else if (file.mimetype.includes('powerpoint') || file.mimetype.includes('presentation')) { iconClass = 'fa-file-powerpoint'; iconColor = 'text-warning'; }
                  else if (file.mimetype.includes('zip') || file.mimetype.includes('rar')) { iconClass = 'fa-file-archive'; iconColor = 'text-warning'; } %>
                  <i class="fas <%= iconClass %> fa-5x <%= iconColor %> mb-3"></i>
                  
                  <!-- Status indicator -->
                  <div class="mt-2">
                    <span class="badge bg-success">
                      <i class="fas fa-cloud"></i> Stored in Cloud
                    </span>
                  </div>
                </div>
                <div class="col-md-9">
                  <table class="table table-bordered">
                    <tr>
                      <th width="30%">File Name</th>
                      <td><%= file.originalName %></td>
                    </tr>
                    <tr>
                      <th>File Type</th>
                      <td><%= file.mimetype %></td>
                    </tr>
                    <tr>
                      <th>File Size</th>
                      <td>
                        <% let size = file.size; let units = ['B', 'KB', 'MB', 'GB']; let i = 0; 
                        while (size >= 1024 && i < units.length - 1) { size /= 1024; i++; } %>
                        <%= size.toFixed(i > 0 ? 1 : 0) %> <%= units[i] %>
                      </td>
                    </tr>
                    <tr>
                      <th>Upload Date</th>
                      <td><%= new Date(file.createdAt).toLocaleString() %></td>
                    </tr>
                    <tr>
                      <th>Last Modified</th>
                      <td><%= new Date(file.updatedAt).toLocaleString() %></td>
                    </tr>
                    <tr>
                      <th>Location</th>
                      <td>
                        <% if (file.folder) { %>
                        <i class="fas fa-folder text-warning"></i> <%= file.folder.name %>
                        <% } else { %>
                        <i class="fas fa-home"></i> Root Directory
                        <% } %>
                      </td>
                    </tr>
                    <tr>
                      <th>Cloud Storage</th>
                      <td>
                        <i class="fas fa-cloud text-info"></i> Cloudinary CDN
                        <small class="text-muted d-block">Global content delivery network</small>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-tools"></i> Actions</h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <!-- Primary download button -->
                <a href="/files/<%= file.id %>/download" class="btn btn-success btn-lg">
                  <i class="fas fa-download"></i> Download File
                </a>
                
                <!-- View in browser (for supported file types) -->
                <% if (file.mimetype.startsWith('image/') || file.mimetype === 'application/pdf' || file.mimetype.startsWith('text/')) { %>
                <a href="/files/<%= file.id %>/view" class="btn btn-info" target="_blank">
                  <i class="fas fa-eye"></i> View in Browser
                </a>
                <% } %>
                
                <!-- Alternative download method -->
                <a href="/files/<%= file.id %>/download-proxy" class="btn btn-outline-success btn-sm">
                  <i class="fas fa-server"></i> Download (Alternative)
                </a>
                
                <!-- Copy file info -->
                <button class="btn btn-secondary" onclick="copyFileInfo()">
                  <i class="fas fa-copy"></i> Copy File Info
                </button>
                
                <!-- Copy direct URL -->
                <button class="btn btn-outline-secondary btn-sm" onclick="copyDirectUrl()">
                  <i class="fas fa-link"></i> Copy Direct URL
                </button>
                
                <!-- Share link -->
                <button class="btn btn-outline-info btn-sm" onclick="shareFile()">
                  <i class="fas fa-share-alt"></i> Share Link
                </button>
                
                <hr>
                
                <!-- Delete button -->
                <form method="POST" action="/files/<%= file.id %>?_method=DELETE" 
                      onsubmit="return confirm('Are you sure you want to delete this file? This action cannot be undone.')">
                  <button type="submit" class="btn btn-danger w-100">
                    <i class="fas fa-trash"></i> Delete File
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- File Preview -->
          <% if (file.mimetype.startsWith('image/')) { %>
          <div class="card mt-3">
            <div class="card-header">
              <h5><i class="fas fa-image"></i> Preview</h5>
            </div>
            <div class="card-body text-center">
              <img src="<%= file.cloudinaryUrl %>" 
                   alt="<%= file.originalName %>" 
                   class="img-fluid rounded shadow"
                   style="max-height: 300px; cursor: pointer;"
                   onclick="openImageModal()"
                   loading="lazy" />
              <div class="mt-2">
                <small class="text-muted">Click to view full size</small>
              </div>
            </div>
          </div>
          <% } %>

          <!-- File Info Card -->
          <div class="card mt-3">
            <div class="card-header">
              <h6><i class="fas fa-info-circle"></i> Technical Details</h6>
            </div>
            <div class="card-body">
              <small class="text-muted">
                <strong>File ID:</strong> <%= file.id %><br>
                <strong>Cloudinary ID:</strong> <%= file.cloudinaryPublicId %><br>
                <strong>MIME Type:</strong> <%= file.mimetype %><br>
                <strong>Size (bytes):</strong> <%= file.size.toLocaleString() %>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Modal for full-size viewing -->
    <% if (file.mimetype.startsWith('image/')) { %>
    <div class="modal fade" id="imageModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><%= file.originalName %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img src="<%= file.cloudinaryUrl %>" 
                 alt="<%= file.originalName %>" 
                 class="img-fluid" />
          </div>
          <div class="modal-footer">
            <a href="/files/<%= file.id %>/download" class="btn btn-primary">
              <i class="fas fa-download"></i> Download Full Resolution
            </a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function copyFileInfo() {
        const fileInfo = `File: <%= file.originalName %>
Size: <%= (file.size / 1024).toFixed(1) %> KB
Type: <%= file.mimetype %>
Uploaded: <%= new Date(file.createdAt).toLocaleString() %>
Cloud URL: <%= file.cloudinaryUrl %>`;
        
        navigator.clipboard.writeText(fileInfo).then(() => {
          showToast('File information copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy: ', err);
          showToast('Failed to copy to clipboard', 'error');
        });
      }

      function copyDirectUrl() {
        navigator.clipboard.writeText('<%= file.cloudinaryUrl %>').then(() => {
          showToast('Direct URL copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy: ', err);
          showToast('Failed to copy to clipboard', 'error');
        });
      }

      function shareFile() {
        const shareData = {
          title: '<%= file.originalName %>',
          text: 'Check out this file: <%= file.originalName %>',
          url: '<%= file.cloudinaryUrl %>'
        };

        if (navigator.share) {
          navigator.share(shareData);
        } else {
          // Fallback to copying URL
          copyDirectUrl();
        }
      }

      <% if (file.mimetype.startsWith('image/')) { %>
      function openImageModal() {
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
      }
      <% } %>

      function showToast(message, type = 'success') {
        // Create toast element
        const toastHtml = `
          <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body">${message}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        `;
        
        // Add to page
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.id = 'toastContainer';
          toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
          document.body.appendChild(toastContainer);
        }
        
        toastContainer.innerHTML = toastHtml;
        const toastElement = toastContainer.querySelector('.toast');
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();
      }
    </script>
  </body>
</html>